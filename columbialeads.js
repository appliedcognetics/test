


fetch = require("node-fetch");
var out = {};
async function zap (output) {
var inputData = { date :'1/1/1970',cc:`cc@gmail.com`, body:`<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html>

<head>

<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<!-- Facebook sharing information tags -->

<meta property="og:title" content="Columbia Lead from LONG YANG for 532 West 111th Street New York, NY 10025">

<title>Columbia Lead from LONG YANG for 532 West 111th Street New York, NY 10025</title>

</head>

<body leftmargin="0" marginwidth="0" topmargin="0" marginheight="0" offset="0" style="-webkit-text-size-adjust: none;margin: 0 auto;padding: 0;background-color: #FAFAFA;width: 93%; max-width:600px;">

<center> 

<table border="0" cellpadding="0" cellspacing="0" height="100%" width="100%" id="backgroundTable" style="margin: 0;padding: 0;background-color: #FAFAFA;height: 100%;width: 100%;">

<tr>

<td align="center" valign="top" style="border-collapse: collapse;">

<!-- // Begin Template Preheader \ -->

<table border="0" cellpadding="10" cellspacing="0" width="100%" id="templatePreheader" style="background-color: #FAFAFA;">

<tr>

<td valign="top" class="preheaderContent" style="border-collapse: collapse;">

</td>

</tr>

</table>

<!-- // End Template Preheader \ -->

<table border="0" cellpadding="0" cellspacing="0" width="100%" id="templateContainer" style="border: 1px solid #DDDDDD;background-color: #FFFFFF;">

<tr>

<td align="center" valign="top" style="border-collapse: collapse;">

<!-- // Begin Template Header \ -->

<table border="0" cellpadding="0" cellspacing="0" width="100%" id="templateHeader" style="background-color: #FFFFFF;border-bottom: 0;">

<tr>

<td class="headerContent" style="border-collapse: collapse;color: #202020;font-family: Arial;font-size: 34px;font-weight: bold;line-height: 100%;padding: 0;text-align: center;vertical-align: middle;">

</td>

</tr>

</table>

<!-- // End Template Header \ -->

</td>

</tr>

<tr>

<td align="center" valign="top" style="border-collapse: collapse;">

<!-- // Begin Template Body \ -->

<table border="0" cellpadding="0" cellspacing="0" width="100%" id="templateBody">

<tr>

<td valign="top" class="bodyContent" style="border-collapse: collapse;background-color: #FFFFFF;">

<!-- // Begin Module: Standard Content \ -->

<table border="0" cellpadding="20" cellspacing="0" width="100%">

<tr>

<td valign="top" style="border-collapse: collapse;">

<div mc:edit="contents" style="color: #505050;font-family: Arial;font-size: 14px;line-height: 150%;text-align: left;"><p style="margin-top:0;font-size:14px;">David Bitton,<br><br>The following individual has expressed an interest in your property listing at the Columbia Off-Campus Housing Assistance. Their contact information is below. Please compose a new email to contact the individual. </p>
<hr style="clear:both; border:none; border-top:1px dotted #999; margin:20px 0;">
<div><br>Name: <strong>LONG YANG</strong><br>Email: <strong><a href="mailto:ly2364%40columbia.edu">ly2364@columbia.edu</a></strong><br>Phone: <strong><a href="tel:+16462502503">(646) 250-2503</a></strong><br>Move-in Availability: <strong>Now</strong> (approximate move-in date)<br>Message: <div><blockquote>
<p>Hi, is it available?</p></blockquote></div></div>
<hr style="clear:both; border:none; border-top:1px dotted #999; margin:20px 0;">
<div style="color:#4d4d4d; margin-bottom:2em;">
<p style="font-size:18px; color:#8f8f8f; margin-bottom:0;">Your Property Listing Overview</p>
<div style="margin-left:1em; margin-top:10px; font-size:16px; line-height:28px; color:#333; font-family:Lato,sans-serif;">532 West 111<br><strong>$3,395</strong> Entire Apt.<br><strong>2</strong> Bedrooms / <strong>1</strong> Bathroom</div>
</div><hr style="clear:both; border:none; border-top:1px dotted #999; margin:20px 0;"><div style="width:100%; color:#a4a4a4;"><div style="padding:6px 3px; line-height:35px;"><a href="http://track.email.offcampuspartners.com/wf/click?upn=MQbpmWILbD-2Bhghcvn2mF1I9Li2o-2FNTqRgld75SnBHtmL2io9yF8fV-2FgzpC6QowRNzKxvxwmQyLJRrUey-2FHWDIm4vxVD5i2I9vtt5v0awQ0s-3D_Ma6wcZHu1PbO3ImqVrWTbjezUgjLFVLsPASzBr3sqaEQXSN2SMwyf0up9Ph3husk4AfNtTV4R8LPWQIvD68X43G6pBsrfDhLaXlXDrBGUHa0xI5hF6lBqhGjocS4ARQ3O7fQcMV80l8AURYeevU0YWow8az646hg0F8EA7fknACFEIVcSCAmLi-2FRmQrEB1yCcYHJyfNPLuERWEtyHWpDGbimhZbYOiVk3iGs7cKhbplz0vVzm-2BRtWhB4f7hoeFzBEzOd8mYNG2yVJ-2F819rOBOd6ppRy2xFhBFzWWd9-2B6imYMxvlF9uMS1ibOVNt1AmyIhUWf1RU7zoupv5l4neXyLhaY7N3w8Cv7Ihn3S173B3t9ZALx9y9skZfdJ0ObW-2FgwioIMvovLiDdbMcVGnxBAYL-2F0FylazDp9tY7eTtdpsiDF40ZXviYxhjc2c8Uvegtn6flmpqck-2BujKT5B5h1CgbuFiVCXQ-2BbEg2CyUjXitUBo-3D">View listing &raquo;</a> <span style="padding:0 10px;"> | </span><a href="http://track.email.offcampuspartners.com/wf/click?upn=MQbpmWILbD-2Bhghcvn2mF1I9Li2o-2FNTqRgld75SnBHtkP85JtIxaGY6KWs-2FT8vSMmkPeCqeCbvcDrYP3iLU2C2hx3JgMS-2BVC-2F09FtVLigt7c-3D_Ma6wcZHu1PbO3ImqVrWTbjezUgjLFVLsPASzBr3sqaEQXSN2SMwyf0up9Ph3husk4AfNtTV4R8LPWQIvD68X43G6pBsrfDhLaXlXDrBGUHa0xI5hF6lBqhGjocS4ARQ3O7fQcMV80l8AURYeevU0YWow8az646hg0F8EA7fknACFEIVcSCAmLi-2FRmQrEB1yCcYHJyfNPLuERWEtyHWpDGbimhZbYOiVk3iGs7cKhbplz0vVzm-2BRtWhB4f7hoeFzBEzOd8mYNG2yVJ-2F819rOBOd6ppRy2xFhBFzWWd9-2B6imYMijZyrbU4Uby15oaKRbfcZ5NsrXbDGDlyfuY07AAv36-2F8OkyrrHMcDnqyby0Ffi6Zv1YH6WQGlpbV-2BKd24zRHiZ2Igx1i790nMjxofkkNTUDG34qdpbL4xJNOYLsoYhWKZwdxUoXfOXkYzJ-2FOZP5lw0DU9ZPC8iI7cHaJnqqV18Ax8SzhLY8lyit-2FfAM4OXk-3D">Edit listing &raquo;</a> <span style="padding:0 10px;"> | </span><a href="http://track.email.offcampuspartners.com/wf/click?upn=MQbpmWILbD-2Bhghcvn2mF1I9Li2o-2FNTqRgld75SnBHtmL2io9yF8fV-2FgzpC6QowRNrQ3oB02M96n7czKDmtbX4VoGlYdDfvzyb4JvuQTsLk3r9RLmnRBX5WZcaCKfhs8H_Ma6wcZHu1PbO3ImqVrWTbjezUgjLFVLsPASzBr3sqaEQXSN2SMwyf0up9Ph3husk4AfNtTV4R8LPWQIvD68X43G6pBsrfDhLaXlXDrBGUHa0xI5hF6lBqhGjocS4ARQ3O7fQcMV80l8AURYeevU0YWow8az646hg0F8EA7fknACFEIVcSCAmLi-2FRmQrEB1yCcYHJyfNPLuERWEtyHWpDGbimhZbYOiVk3iGs7cKhbplz0vVzm-2BRtWhB4f7hoeFzBEzOd8mYNG2yVJ-2F819rOBOd6ppRy2xFhBFzWWd9-2B6imYJ4yNvx6vKqaDcgzA90Iz6JGDpXYGp-2Bn574uk9Pplj6JL-2BdmYYgjYC5J9yKitlREDnwnoEDEanQLQoZVGdLVi-2Bx1TNuVckdP7MjAGjpteymi1b-2FXkmS6vDuK1EyUMfVCaeSfwuwl0IKtGYJLEE4SKJbj2KpP-2Fn6St0lWrmxHeQ2EX4dP-2BRdfaqfiuziYZaR9M-3D">Deactivate listing &raquo;</a> </div>This email was sent through the <a href="http://track.email.offcampuspartners.com/wf/click?upn=MQbpmWILbD-2Bhghcvn2mF1I9Li2o-2FNTqRgld75SnBHtn2sKsXELxYkB9ap1YfL2Pa_Ma6wcZHu1PbO3ImqVrWTbjezUgjLFVLsPASzBr3sqaEQXSN2SMwyf0up9Ph3husk4AfNtTV4R8LPWQIvD68X43G6pBsrfDhLaXlXDrBGUHa0xI5hF6lBqhGjocS4ARQ3O7fQcMV80l8AURYeevU0YWow8az646hg0F8EA7fknACFEIVcSCAmLi-2FRmQrEB1yCcYHJyfNPLuERWEtyHWpDGbimhZbYOiVk3iGs7cKhbplz0vVzm-2BRtWhB4f7hoeFzBEzOd8mYNG2yVJ-2F819rOBOd6ppRy2xFhBFzWWd9-2B6imaib9P-2BnUx5y22tTnYjVq64eKuNL8gwpqSoTuU-2Fsxdc2h4G-2F-2BxHHNu83-2BvQeFVhM263uvPvAvognNBjfaTwZM2IZAJK1zAsQCNqETGSEkLkq0HbSPmU1o8WPaxueHCJNf5-2BCedomTU23w47R-2BYDCXzMqW41bTFNI2bcQBeSE7SUXXQiIbaX1Am-2Fc-2FS7R9MRlEs-3D">Columbia Off-Campus Housing Assistance</a> website and is intended for Trey Parker .</div><div style="color:#444;"><a href="http://track.email.offcampuspartners.com/wf/click?upn=MQbpmWILbD-2Bhghcvn2mF1I9Li2o-2FNTqRgld75SnBHtk1dJgwHfN4g4L4pOHMfMv4PMV8hMJ7CSk20RmUFb9zTQ-3D-3D_Ma6wcZHu1PbO3ImqVrWTbjezUgjLFVLsPASzBr3sqaEQXSN2SMwyf0up9Ph3husk4AfNtTV4R8LPWQIvD68X43G6pBsrfDhLaXlXDrBGUHa0xI5hF6lBqhGjocS4ARQ3O7fQcMV80l8AURYeevU0YWow8az646hg0F8EA7fknACFEIVcSCAmLi-2FRmQrEB1yCcYHJyfNPLuERWEtyHWpDGbimhZbYOiVk3iGs7cKhbplz0vVzm-2BRtWhB4f7hoeFzBEzOd8mYNG2yVJ-2F819rOBOd6ppRy2xFhBFzWWd9-2B6imaHoh6vWsWWxJkaHEbKcmeKzN8IuOv1WhZ5wXzbuBUkNwWI3Zvh41uLnLIH1uwUltmMhWATJVG6-2BjeIeDDUrjA11VwOpfTcNve2zmFGKJAiertdFk4WOSSy-2BZfrNcw3LRRFobcRFm00Olr4B0l5K-2FnmhtgKuO0W0a5-2Ff1kTKd-2F7qBns8SvG8A6kFr91O4J2YUM-3D" style="color:#900;">Learn about scams.</a><br>Forward suspected scams to <a style="color:#222;" href="mailto:scam@offcampuspartners.com">scam@offcampuspartners.com</a></div></div>

</td>

</tr>

</table>

<!-- // End Module: Standard Content \ -->

</td>

</tr>

</table>

<!-- // End Template Body \ -->

</td>

</tr>

<tr>

<td align="center" valign="top" style="border-collapse: collapse;">

<!-- // Begin Template Footer \ -->

<table border="0" cellpadding="10" cellspacing="0" width="100%" id="templateFooter" style="background-color: #FFFFFF;border-top: 0;">

<tr>

<td valign="top" class="footerContent" style="border-collapse: collapse;">

<!-- // Begin Module: Standard Footer \ -->

<table border="0" cellpadding="10" cellspacing="0" width="100%">

<tr>

<td valign="top" width="58.333%" style="border-collapse: collapse;">

<div mc:edit="std_footer" style="color: #707070;font-family: Arial;font-size: 12px;line-height: 125%;text-align: left;">

</div>

</td>

</tr>

<tr>

<td colspan="2" valign="middle" id="utility" style="border-collapse: collapse;background-color: #FFFFFF;border: 0;">

<div mc:edit="std_utility" style="color: #707070;font-family: Arial;font-size: 12px;line-height: 125%;text-align: center;">

</div>

</td>

</tr>

</table>

<!-- // End Module: Standard Footer \ -->

</td>

</tr>

</table>

<!-- // End Template Footer \ -->

</td>

</tr>

</table>

<br>

</td>

</tr>

</table>

</center>

<img src="http://track.email.offcampuspartners.com/wf/open?upn=Ma6wcZHu1PbO3ImqVrWTbjezUgjLFVLsPASzBr3sqaEQXSN2SMwyf0up9Ph3husk4AfNtTV4R8LPWQIvD68X43G6pBsrfDhLaXlXDrBGUHa0xI5hF6lBqhGjocS4ARQ3O7fQcMV80l8AURYeevU0YWow8az646hg0F8EA7fknACFEIVcSCAmLi-2FRmQrEB1yCcYHJyfNPLuERWEtyHWpDGbimhZbYOiVk3iGs7cKhbplz0vVzm-2BRtWhB4f7hoeFzBEzOd8mYNG2yVJ-2F819rOBOd6ppRy2xFhBFzWWd9-2B6imbB-2B5n5O96qmuuSFtG3o5VTrFFb1f2yXJG8mJdZPvpr52NrxqiF62WxM8-2BLqdVQUdwhwj5jycEe5DzQ0WUsIqP3zJzx5-2B884KrQIkWRicnmNQTi-2Fja0btjWV0Km-2BejCozaFKffffONW2PfeY-2BhqzWVMa36ASzGSVXwORCr0rtDrhobF2kKEmonUD9cqh9tiFhI-3D" alt="" width="1" height="1" border="0" style="height:1px !important;width:1px !important;border-width:0 !important;margin-top:0 !important;margin-bottom:0 !important;margin-right:0 !important;margin-left:0 !important;padding-top:0 !important;padding-bottom:0 !important;padding-right:0 !important;padding-left:0 !important;"/>
</body>

</html>


`};
//to:me from:noreply@streeteasy.com Search String for street easy

/* */
const pluscodekey ="AIzaSyBqeAMkHMiXKA-3QiBKqjryi3X9cof2FZM";
const emailregex = /([a-zA-Z0-9._-]+@[a-zA-Z0-9._-]+\.[a-zA-Z0-9_-]+)/i;
const phoneregex =/(\(?[0-9]{3}\)?[-.\s]?[0-9]{3}[-.\s]?[0-9]{4})/i;


function  getpluscode (listing) {
  // returns the promise of getting the vid for the given email
  //console.log ("url"+(`https://plus.codes/api/?address=${encodeURIComponent(listing)}&key=${pluscodekey}`));
     return  fetch (`https://plus.codes/api/?address=${encodeURIComponent(listing)}&key=${pluscodekey}`).then(response => response.json())
    .then(data => ( !(data.plus_code ==="undefined") ? data.plus_code.global_code :"missing")  )
    .catch(error => {console.error(error)})
}

function replacer (match,capture,offset,wholestring) 
{return String.fromCharCode(parseInt(capture,16)) };

   function rp2 (match,capture,offset,wholestring) 
{  // Do different operations for different tags

// this is for an alt tage in an image     
// if  (capture.replace(/^img[^>]+alt=3D\W([\w]+)\W>/g,'[$1]')) {return "["+capture+"]"}
if (capture.match (/alt=3D|alt=\W([\w]+)\W/)) { return "["+capture.match (/alt=3D|alt=\W([\w]+)\W/)[1]+"]";}  ///^img[^>]+alt=3D\W([\w]+)\W/
// preserve any anchor tags
if (capture.match (/^a[^>]+(https?:[^"]+)\W/)) { return "["+capture.match (/^a[^>]+(https?:[^"]+)\W/)[1]+"]";} 
if (capture.match (/^a[^>]+(mailto?:[^"]+)\W/)) { return "["+capture.match (/^a[^>]+(mailto?:[^"]+)\W/)[1]+"]";} 
// preserve any emails embedded in <> 
if (capture.match (/^([a-zA-Z0-9._-]+@[a-zA-Z0-9._-]+\.[a-zA-Z0-9_-]+)/)) { return "["+capture+"]" } 
// return a lf for a td for zillow might process differently for other providers
if (capture.match (/^tr/)) { return "\n" } 
if (capture.match (/br/)) { return "\n" }  // for Columbia Leads 
//End Blocks with a delimiter "###"
if (capture.match (/^table/)) { return "###" } 
//if (capture.match (/^br/)) { return "###" } 
// otherwise return "" 
return "";
};

var f = {};

f.body=inputData.body.replace(/=\s\n/g,"").replace(/<head[\W\w]*<\/head>/,"").replace(/<style[^<]*<\/style>/ig,"").replace(/\<([^>]+)>/g,rp2).replace(/\n?=C2=A0\n?/g," ").replace(/=([A-F0-9]{2})/g," ");
 const note = (f.body.match(/message\:[\s\n]*(.+)/i) || [])[1]||"-";
 const l = (f.body.match(/listing\soverview[\s\n]*(.+)/i) || [])  [1]||"-";
 console.log (f.body);
  const name = (f.body.match(/name\:[\s\n]*(.*)/i) || [])[1]||"-";
 const em = (f.body.match(/email\:[^\]]*\]([a-zA-Z0-9._-]+@[a-zA-Z0-9._-]+\.[a-zA-Z0-9_-]+)/i) || [])[1]||"-";
 const phone = ((f.body.match(/phone:[\s\n]*(\(?[0-9]{3}\)?[-.\s]?[0-9]{3}[-.\s]?[0-9]{4})/i) || [])[1]||"-").replace(/[^\d]/g,'') ;
 const moveindate = (f.body.match(/Move\-in\sAvailability\:[\s\n]*(.*)/i) || [])[1]||"-";

f.source = "Columbia University"
f.note =   note.trim();
f.listing = l||"-"  ;
f.listingurl = "-";
f.email =  em ? em.trim() : "-";  
f.name  =  name ? name.trim() : "-" ;  
f.from  =  inputData.from; 
f.cc    =  inputData.cc;  
f.date  =  inputData.date;  
f.phone =  phone ;
f.moveindate = moveindate || "-";
/// ************* LOOK FOR A PHONE NUMBER IN THE NOTE  
const altphone=(f.note.match(phoneregex)||[])[1];
f.phone = altphone && !f.phone ? altphone : f.phone;                                
f.pluscode = await getpluscode(f.listing);
                             
 
// *********** Turn this into a function
// find and name and split it into 1st and last name
if (!emailregex.test(f.name)) {
  //if the f.name is not an email
  // try to split the fname on spaces 
const namesplit = f.name.trim().split(/\s+/);
// Logger.log ("\nns:"+namesplit);
if (namesplit.length > 1 ) { f.firstname = namesplit[0]; 
                            f.lastname =namesplit.pop();}
  else { f.firstname =f.name , f.lastname = "-";}
}
// try to find the name in the email address
//  Logger.log ("\nf.name:"+f.name);
//  Logger.log ("\nf.lastname:"+f.lastname);
//   Logger.log ("\nf.firstname:"+f.firstname);
// *********** Turn this into a function
  if (emailregex.test (f.name)){
    // maybe there is a name in the Email Address
  const esplit = (f.name.split (/@/)[0].split('.'));
    if (esplit.length > 0) {f.name = esplit.join(" ");
                            f.firstname = esplit[0]; 
                            f.lastname =esplit.pop();
     };
  };

 
  const agent = (function (cc) {
    switch (cc){
    case 'chris@coulthrust.com' : return {sms :'+13473709408',hubspotid :'35013679'}  
    case 'david@stonecrestrealty.com' : return {sms :'+16173080839',hubspotid:'35029194'}
    case 'caroline@stonecrestrealty.com':return{sms:'+13473709408',hubspotid:'35029193'}
    case 'tzur@stonecrestrealty.com' : return {sms:'+13476851115',hubspotid:'35032776'}
    case 'f.z@stonecrestrealty.com' : return {sms:'+13473709408',hubspotid:'35028612'}
    default : return {sms:'+13473709408',hubspotid:'35013679'};
    }})(inputData.cc);

  f.smsnote = (f.name+':'+f.email+":"+f.phone+":"+f.listing+":"+f.note).trim().slice(0,160);    

 return  {source: f.source,phone : f.phone,name : f.name,email :f.email,note:f.note,listing:f.listing,
    listingurl:f.listingurl,firstname :f.firstname,lastname : f.lastname , sms :agent.sms , moveindate:f.moveindate, 
    hubspotid:agent.hubspotid,smsnote: f.smsnote,
pluscode : f.pluscode};
  

 }

 Promise.all([zap()]).then(output => console.log(JSON.stringify(output[0]))) ; 
 


// Get the plus code, match the plus code for the owning sales person, get any messaging or alerts for the apartment
// Send the text message or email message for the apartment
// Design a chain of messages of the apartment
// Analyze all of the responses from the sales person , responses for particular queries
// Send a message to John about this idea of analyzing responses




// get the best street address and the local_code 
// await for the 
//console.log ("ppp"+pluscodekey);
 // console.log("op"+op);
 /*
  console.log (f.listingurl);
  console.log (f.cc);
  console.log (f.phone);
  console.log (f.name);
  console.log (f.listing);
  console.log (f.firstname);
  console.log (f.lastname);
  console.log (f.email);
  console.log (f.note);
  console.log (f.date);
  console.log (agent.sms);
  console.log (agent.hubspotid);
  console.log(f.creditscore );
  console.log(f.income );
  console.log(f.jobtitle );
  console.log(f.employer);
  console.log(f.employedsince);
  console.log(f.pastjobs );
  console.log(f.reasonformoving );
  console.log(f.employer);
  console.log(f.pets );
  console.log(f.leaselength );
  console.log(f.parking );
  console.log(f.employer );
  console.log(f.desiredneighborhood );
  console.log(f.smoker );
*/
//  console.log (f.body);


/*
Function to get the plusCode
function plusCode(address) {
  
  if (!address) {return ('no address')}
 
 var url = 'https://plus.codes/api/?'
   + 'address='+encodeURIComponent(address) 
   + '&key=AIzaSyBqeAMkHMiXKA-3QiBKqjryi3X9cof2FZM';
  
var response =UrlFetchApp.fetch(url);
 // use the global code because that value is unique at least
console.log(JSON.parse(response).plus_code.global_code); 
 return response ?  JSON.parse(response).plus_code.global_code : "Missing"
}
*/
